<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8" />
        <title>Cool Simulation</title>
        <script
              src="https://code.jquery.com/jquery-3.7.1.min.js"
              integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
              crossorigin="anonymous"></script>
		<script type="module">
			import * as d3 from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
			
			$(document).ready(function() {
                clearResults();
				resetDefaults();

                $("#make-results-button").click(function() {
                	doSimulation();
                });

                $(".reset-button").click(function() {
                    clearResults();
                });
				
				$("#reset-defaults-button").click(function() {
					resetDefaults();
				});

				$("#input-real-mode").change(function() {
					updateRealMode();
			    });
            });
			
			var SimData = {
				P0: {x:0, y:0},
				P1: {x:0, y:0},
				P2: {x:0, y:0},
				P3: {x:0, y:0},
				CalcP1: {x:0, y:0},
				CalcP2: {x:0, y:0},
				NumSlices: 0,
				RealMode: false
			};
			var CalculatedPoints = [];
			
			function resetDefaults()
			{
				SimData.P0 = {x:0, y:0};
				SimData.P1 = {x:3, y:9};
				SimData.P2 = {x:6, y:10};
				SimData.P3 = {x:10, y:10};
				SimData.CalcP1 = {x:0, y:0};
				SimData.CalcP2 = {x:0, y:0};
				SimData.NumSlices = 10;
				SimData.RealMode = false;

				displaySetupData();
			}

			function displaySetupData()
			{
				$("#input-p0-x").val(SimData.P0.x);
				$("#input-p0-y").val(SimData.P0.y);
				$("#input-p1-x").val(SimData.P1.x);
				$("#input-p1-y").val(SimData.P1.y);
				$("#input-p2-x").val(SimData.P2.x);
				$("#input-p2-y").val(SimData.P2.y);
				$("#input-p3-x").val(SimData.P3.x);
				$("#input-p3-y").val(SimData.P3.y);
				$("#input-num-slices").val(SimData.NumSlices);
				$("#input-real-mode").val(SimData.RealMode);

				if(SimData.RealMode) {
					$("#input-p1-label").html("P1 (Real Point 1)");
					$("#input-p2-label").html("P2 (Real Point 2)");
				}
				else {
					$("#input-p1-label").html("P1 (Control Point 1)");
					$("#input-p2-label").html("P2 (Control Point 2)");
				}
			}

			function doSimulation()
			{
				gatherInputs();
				calculateControlPoints();
				calculateGraph();
				makeOutput();
			}
			
			function gatherInputs()
			{
				SimData.P0.x = Number($("#input-p0-x").val());
				SimData.P0.y = Number($("#input-p0-y").val());
				SimData.P1.x = Number($("#input-p1-x").val());
				SimData.P1.y = Number($("#input-p1-y").val());
				SimData.P2.x = Number($("#input-p2-x").val());
				SimData.P2.y = Number($("#input-p2-y").val());
				SimData.P3.x = Number($("#input-p3-x").val());
				SimData.P3.y = Number($("#input-p3-y").val());
				SimData.NumSlices = Number($("#input-num-slices").val());
				SimData.RealMode = $("#input-real-mode").is(":checked");
			}

			function updateRealMode()
			{
				SimData.RealMode = $("#input-real-mode").is(":checked");
				displaySetupData();
			}

			function calculateControlPoints()
			{
				if(SimData.RealmMode) {
					// TODO: We have to actually calculate the values!
					// For now we'll just copy over the values as if we were in normal mode.
					SimData.CalcP1.x = SimData.P1.x;
					SimData.CalcP1.y = SimData.P1.y;
					SimData.CalcP2.x = SimData.P2.x;
					SimData.CalcP2.y = SimData.P2.y;
				}
				else {
					SimData.CalcP1.x = SimData.P1.x;
					SimData.CalcP1.y = SimData.P1.y;
					SimData.CalcP2.x = SimData.P2.x;
					SimData.CalcP2.y = SimData.P2.y;
				}
			}

            function calculatePointOnCurve(t)
            {
                // B(t) = (1−t)^3*P0 + 3*(1−t)^2*t*P1 + 3*(1−t)*t^2*P2 + t^3*P3 where 0≤t≤1
                // P0, P1, P2, and P3 are the control points for the curve

                if(t === 0) {
                    return SimData.P0;
                }

                var invT = (1 - t);

                var p0result = {x:0, y:0};
                var p1result = {x:0, y:0};
                var p2result = {x:0, y:0};
                var p3result = {x:0, y:0};

                // remember, quick-and-dirty... this math is not optimized ;)

                p0result.x = Math.pow(invT, 3) * SimData.P0.x;
                p0result.y = Math.pow(invT, 3) * SimData.P0.y;

                p1result.x = 3 * Math.pow(invT, 2) * t * SimData.CalcP1.x;
                p1result.y = 3 * Math.pow(invT, 2) * t * SimData.CalcP1.y;

                p2result.x = 3 * invT * Math.pow(t, 2) * SimData.CalcP2.x;
                p2result.y = 3 * invT * Math.pow(t, 2) * SimData.CalcP2.y;

                p3result.x = Math.pow(t, 3) * SimData.P3.x;
                p3result.y = Math.pow(t, 3) * SimData.P3.y;

                return {x: p0result.x + p1result.x + p2result.x + p3result.x, y: p0result.y + p1result.y + p2result.y + p3result.y};
            }

            function calculateGraph()
            {
            	CalculatedPoints.length = 0;

            	for(var slice = 0; slice <= SimData.NumSlices; ++slice) {
                    CalculatedPoints.push(calculatePointOnCurve(slice / SimData.NumSlices));
                }
            }

            function makeOutput()
            {
                var output = "<table border='1'><tr><th>Slice</th><th>x</th><th>y</th></tr>";
                for(var i = 0; i < CalculatedPoints.length; ++i) {
                    output += "<tr><td>" + i + "</td><td>" + CalculatedPoints[i].x + "</td><td>" + CalculatedPoints[i].y + "</td></tr>";
                }
                output += "</table>";

                $("#results-table").html(output);
                $("#results-area").show();
				
				makeGraph();

				if(SimData.RealMode) {
					output = "<table border='1'>";
					output += "<tr><th>Name</th><th>x</th><th>y</th></tr>"
					output += "<tr><td>Control Point 1</td><td>" + SimData.CalcP1.x + "</td><td>" + SimData.CalcP1.y + "</tr>";
					output += "<tr><td>Control Point 2</td><td>" + SimData.CalcP2.x + "</td><td>" + SimData.CalcP2.y + "</tr>";
	                output += "</table>";

					$("#results-real-mode").show().html(output);
				}
				else {
					$("#results-real-mode").hide().html("");
				}
            }

            function clearResults()
            {
                $("#results-area").hide();
                $("#results-table").html("");
            }
			
			// Arbitrary dimensions
			const width = 800;
			const height = 600;
			const marginTop = 100;
			const marginRight = 100;
			const marginBottom = 100;
			const marginLeft = 100;
			
			function GetSimRangeWidth()
			{
				return SimData.P3.x - SimData.P0.x;
			}
			
			function GetSimRangeHeight()
			{
				return SimData.P3.y - SimData.P0.y;
			}
			
			function getXGraphPoint(x)
			{
				// We have to fit in our space, so we need the actual width of the draw space (within the margins)
				var totalWidth = width - marginLeft - marginRight;
				// The coordinate is our percent in the space
				var coord = (x - SimData.P0.x) / GetSimRangeWidth();
				return (coord * totalWidth) + marginLeft;
			}
			
			function getYGraphPoint(y)
			{
				// We have to fit in our space, so we need the actual height of the draw space (within the margins)
				var totalHeight = height - marginTop - marginBottom;
				// The coordinate is our percent in the space
				var coord = (y - SimData.P0.y) / GetSimRangeHeight();
				// Note that for y <0,0> is the top left of the DOM element, so we need to flip
				return (-coord * totalHeight) + (height - marginBottom);
			}
			
			function drawCurve(context)
			{
				context.moveTo(getXGraphPoint(SimData.P0.x), getYGraphPoint(SimData.P0.y));
				context.bezierCurveTo(getXGraphPoint(SimData.P1.x), getYGraphPoint(SimData.P1.y), getXGraphPoint(SimData.P2.x), getYGraphPoint(SimData.P2.y), getXGraphPoint(SimData.P3.x), getYGraphPoint(SimData.P3.y));
				return context;
			}

			function makeGraph()
			{
				const x = d3.scaleLinear()
					.domain([SimData.P0.x, SimData.P3.x])
					.range([marginLeft, width - marginRight]);
				const y = d3.scaleLinear()
					.domain([SimData.P0.y, SimData.P3.y])
					.range([height - marginBottom, marginTop]);

				const svg = d3.create("svg")
					.attr("width", width)
					.attr("height", height);

				// x-axis
				svg.append("g")
					.attr("transform", `translate(0,${height - marginBottom})`)
					.call(d3.axisBottom(x));

				// y-axis
				svg.append("g")
					.attr("transform", `translate(${marginLeft},0)`)
					.call(d3.axisLeft(y));
					
				// curve
				svg.append("path")
					.style("stroke", "black")
					.style("fill", "none")
					.attr("d", drawCurve(d3.path()));

				$("#results-graph").html(svg.node());
			}
		</script>
        <style>
            #results-area {
                margin-top: 50px;
            }

            table {
                border: 1px;
                border-collapse: collapse;

                th {
                    padding: 5px;
                }

                td {
                    padding: 5px;
                }
            }
			
			.top-bot-space-small {
				margin: 10px 0 10px 0;
			}
        </style>
    </head>
    <body>
        <h1>Super Cool Simulation</h1>

        <div id="setup-data">
        	<div><label>Real Mode: </label><input type="checkbox" id="input-real-mode" /></div>
			<table border='1'>
				<tr>
					<th>Control Point</th>
					<th>x</th>
					<th>y</th>
				</tr>
				<tr>
					<td><label id="input-p0-label">P0 (Starting Point)</label></td>
					<td><input type="text" id="input-p0-x" /></td>
					<td><input type="text" id="input-p0-y" /></td>
				</tr>
				<tr>
					<td><label id="input-p1-label">P1 "(ontrol Point 1)</label></td>
					<td><input type="text" id="input-p1-x" /></td>
					<td><input type="text" id="input-p1-y" /></td>
				</tr>
				<tr>
					<td><label id="input-p2-label">P2 (Control Point 2)</label></td>
					<td><input type="text" id="input-p2-x" /></td>
					<td><input type="text" id="input-p2-y" /></td>
				</tr>
				<tr>
					<td><label id="input-p3-label">P3 (End Point)</label></td>
					<td><input type="text" id="input-p3-x" /></td>
					<td><input type="text" id="input-p3-y" /></td>
				</tr>
			</table>
			<div class="top-bot-space-small"><label>Number of Slices:</label> <input type="text" id="input-num-slices" /></div>
			<div class="top-bot-space-small"><button type="button" id="make-results-button">Calculate</button> <button type="button" id="reset-defaults-button">Defaults</button></div>
		</div>

        <div id="results-area">
			<div class="top-bot-space-small"><h2>Results</h2></div>
			<div class="top-bot-space-small"><button type="button" class="reset-button">Reset</button></div>
			<div class="top-bot-space-small" id="results-real-mode"></div>
			<div class="top-bot-space-small" id="results-graph"></div>
            <div class="top-bot-space-small" id="results-table"></div>
            <div class="top-bot-space-small"><button type="button" class="reset-button">Reset</button></div>
        </div>
    </body>
</html>
